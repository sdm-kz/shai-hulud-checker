<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shai Hulud 2 Trojan - Package Checker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #ff6b6b;
            font-size: 2.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: #a0a0a0;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-card.danger {
            border-color: rgba(255,107,107,0.5);
            background: rgba(255,107,107,0.1);
        }
        
        .stat-card.warning {
            border-color: rgba(255,193,7,0.5);
            background: rgba(255,193,7,0.1);
        }
        
        .stat-card.success {
            border-color: rgba(75,192,192,0.5);
            background: rgba(75,192,192,0.1);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card.danger .stat-value { color: #ff6b6b; }
        .stat-card.warning .stat-value { color: #ffc107; }
        .stat-card.success .stat-value { color: #4bc0c0; }
        
        .stat-label {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.02);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #4bc0c0;
            background: rgba(75,192,192,0.1);
        }
        
        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .upload-area input {
            display: none;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .btn {
            background: linear-gradient(135deg, #4bc0c0 0%, #36a2a2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        }
        
        .result-item {
            background: rgba(255,107,107,0.15);
            border: 1px solid rgba(255,107,107,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .result-item.safe {
            background: rgba(75,192,192,0.15);
            border-color: rgba(75,192,192,0.3);
        }
        
        .package-name {
            font-weight: bold;
            font-family: 'Monaco', 'Menlo', monospace;
            color: #ff6b6b;
        }
        
        .result-item.safe .package-name {
            color: #4bc0c0;
        }
        
        .package-source {
            color: #a0a0a0;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            float: right;
        }
        
        .badge-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .badge-safe {
            background: #4bc0c0;
            color: white;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 40px;
            color: #a0a0a0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #4bc0c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-danger {
            background: rgba(255,107,107,0.2);
            border: 1px solid rgba(255,107,107,0.4);
            color: #ff8a8a;
        }
        
        .alert-success {
            background: rgba(75,192,192,0.2);
            border: 1px solid rgba(75,192,192,0.4);
            color: #6fd6d6;
        }
        
        .alert-info {
            background: rgba(100,149,237,0.2);
            border: 1px solid rgba(100,149,237,0.4);
            color: #87b1ff;
        }
        
        .package-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
        }
        
        .package-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .package-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .package-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        
        .source-info {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-top: 5px;
        }
        
        .source-info a {
            color: #4bc0c0;
            text-decoration: none;
        }
        
        .source-info a:hover {
            text-decoration: underline;
        }
        
        .filename {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            display: inline-block;
        }
        
        .match-context {
            font-size: 0.8em;
            color: #888;
            font-family: monospace;
            margin-top: 5px;
            word-break: break-all;
        }
        
        .error-message {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
        }
        
        .load-status {
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .load-status .success { color: #4bc0c0; }
        .load-status .error { color: #ff6b6b; }
        .load-status .pending { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>üêõ</span> Shai Hulud 2 Trojan Checker</h1>
            <p class="subtitle">Verify your lock files against known compromised packages</p>
        </header>
        
        <div id="loadingScreen" class="section">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading affected packages database...</div>
                <div class="load-status">
                    <div id="aikidoStatus" class="pending">‚è≥ Aikido Blog: Loading...</div>
                    <div id="wizStatus" class="pending">‚è≥ Wiz IOC CSV: Loading...</div>
                </div>
            </div>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card warning">
                    <div class="stat-value" id="aikidoCount">-</div>
                    <div class="stat-label">Aikido Blog Packages</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="wizCount">-</div>
                    <div class="stat-label">Wiz IOC Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAffected">-</div>
                    <div class="stat-label">Total Unique Packages</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="foundCount">0</div>
                    <div class="stat-label">Matches Found</div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">üì§ Upload Lock File</h2>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".yaml,.yml,.json,.lock">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop your lock file here or click to browse</div>
                    <div class="upload-hint">Supports pnpm-lock.yaml, package-lock.json, yarn.lock, etc.</div>
                </div>
                <div id="uploadedFile" style="display:none; margin-top: 15px;">
                    <span class="filename" id="uploadedFileName"></span>
                    <button class="btn btn-danger" onclick="clearFile()" style="margin-left: 10px;">‚úï Clear</button>
                </div>
            </div>
            
            <div class="section" id="resultsSection" style="display:none;">
                <h2 class="section-title">üîç Scan Results</h2>
                <div id="resultsAlert"></div>
                <div class="package-list" id="resultsList"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">üìã Affected Packages Database</h2>
                <div class="source-info">
                    <strong>Source 1:</strong> <a href="https://www.aikido.dev/blog/shai-hulud-strikes-again-hitting-zapier-ensdomains" target="_blank">Aikido Blog</a>
                </div>
                <div class="source-info" style="margin-bottom: 15px;">
                    <strong>Source 2:</strong> <a href="https://github.com/wiz-sec-public/wiz-research-iocs/blob/main/reports/shai-hulud-2-packages.csv" target="_blank">Wiz Security IOCs</a>
                </div>
                <input type="text" id="searchAffected" placeholder="üîç Search affected packages..." 
                       style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); 
                              background:rgba(0,0,0,0.2); color:#fff; margin-bottom:15px; font-size:1em;">
                <div class="package-list" id="affectedList"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let affectedPackages = new Set();
        let aikidoPackages = new Set();
        let wizPackages = new Set();
        let fileContent = '';
        let loadingComplete = false;
        
        // URLs
        const AIKIDO_URL = 'https://www.aikido.dev/blog/shai-hulud-strikes-again-hitting-zapier-ensdomains';
        const WIZ_CSV_URL = 'https://raw.githubusercontent.com/wiz-sec-public/wiz-research-iocs/refs/heads/main/reports/shai-hulud-2-packages.csv';
        
        // Parse packages from Aikido blog HTML
        function parseAikidoBlog(html) {
            const packages = new Set();
            
            // Look for package patterns like @scope/name or package-name followed by version info
            // The blog lists them as "- @zapier/zapier-sdk (0.15.5, 0.15.6, 0.15.7)"
            const lines = html.split('\n');
            for (const line of lines) {
                // Match lines starting with "- " followed by package name
                const match = line.match(/^-\s+(@[\w-]+\/[\w.-]+|[\w][\w.-]*)/);
                if (match) {
                    packages.add(match[1]);
                }
            }
            
            return packages;
        }
        
        // Parse Wiz CSV
        function parseWizCSV(csv) {
            const packages = new Set();
            const lines = csv.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const commaIndex = line.indexOf(',');
                if (commaIndex > 0) {
                    const pkgName = line.substring(0, commaIndex).trim();
                    if (pkgName) {
                        packages.add(pkgName);
                    }
                }
            }
            
            return packages;
        }
        
        // Fetch with CORS proxy fallback
        async function fetchWithFallback(url) {
            // Try direct fetch first
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return await response.text();
                }
            } catch (e) {
                console.log('Direct fetch failed, trying proxy...');
            }
            
            // Try CORS proxy
            const proxyUrls = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];
            
            for (const proxyUrl of proxyUrls) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (e) {
                    console.log('Proxy fetch failed:', proxyUrl);
                }
            }
            
            throw new Error('All fetch attempts failed');
        }
        
        // Load packages from sources
        async function loadPackages() {
            let aikidoLoaded = false;
            let wizLoaded = false;
            
            // Load Aikido blog
            try {
                document.getElementById('aikidoStatus').className = 'pending';
                document.getElementById('aikidoStatus').textContent = '‚è≥ Aikido Blog: Loading...';
                
                const html = await fetchWithFallback(AIKIDO_URL);
                aikidoPackages = parseAikidoBlog(html);
                
                document.getElementById('aikidoStatus').className = 'success';
                document.getElementById('aikidoStatus').textContent = `‚úì Aikido Blog: ${aikidoPackages.size} packages`;
                aikidoLoaded = true;
            } catch (e) {
                console.error('Failed to load Aikido blog:', e);
                document.getElementById('aikidoStatus').className = 'error';
                document.getElementById('aikidoStatus').textContent = '‚úó Aikido Blog: Failed to load';
            }
            
            // Load Wiz CSV
            try {
                document.getElementById('wizStatus').className = 'pending';
                document.getElementById('wizStatus').textContent = '‚è≥ Wiz IOC CSV: Loading...';
                
                const csv = await fetchWithFallback(WIZ_CSV_URL);
                wizPackages = parseWizCSV(csv);
                
                document.getElementById('wizStatus').className = 'success';
                document.getElementById('wizStatus').textContent = `‚úì Wiz IOC CSV: ${wizPackages.size} packages`;
                wizLoaded = true;
            } catch (e) {
                console.error('Failed to load Wiz CSV:', e);
                document.getElementById('wizStatus').className = 'error';
                document.getElementById('wizStatus').textContent = '‚úó Wiz IOC CSV: Failed to load';
            }
            
            // Merge all packages
            for (const pkg of aikidoPackages) {
                affectedPackages.add(pkg);
            }
            for (const pkg of wizPackages) {
                affectedPackages.add(pkg);
            }
            
            // Check if at least one source loaded
            if (aikidoLoaded || wizLoaded) {
                loadingComplete = true;
                
                // Short delay to show final status
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    updateStats();
                    renderAffectedList();
                }, 500);
            } else {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="error-message">
                        <h3>‚ö†Ô∏è Failed to load package database</h3>
                        <p>Could not fetch data from either source. Please check your internet connection and try again.</p>
                        <button class="btn" onclick="location.reload()" style="margin-top: 15px;">Retry</button>
                    </div>
                `;
            }
        }
        
        // Update stats display
        function updateStats() {
            document.getElementById('aikidoCount').textContent = aikidoPackages.size;
            document.getElementById('wizCount').textContent = wizPackages.size;
            document.getElementById('totalAffected').textContent = affectedPackages.size;
        }
        
        // Render affected packages list
        function renderAffectedList(filter = '') {
            const filterLower = filter.toLowerCase();
            const filtered = [...affectedPackages]
                .filter(pkg => pkg.toLowerCase().includes(filterLower))
                .sort();
            
            const html = filtered.slice(0, 200).map(pkg => {
                const inAikido = aikidoPackages.has(pkg);
                const inWiz = wizPackages.has(pkg);
                const sources = [];
                if (inAikido) sources.push('Aikido');
                if (inWiz) sources.push('Wiz');
                
                return `
                    <div class="result-item">
                        <span class="badge badge-danger">AFFECTED</span>
                        <span class="package-name">${escapeHtml(pkg)}</span>
                        <span class="package-source">(${sources.join(', ')})</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('affectedList').innerHTML = html || 
                '<div style="text-align:center;color:#a0a0a0;padding:20px;">No packages match the filter</div>';
            
            if (filtered.length > 200) {
                document.getElementById('affectedList').innerHTML += 
                    `<div style="text-align:center;color:#a0a0a0;padding:10px;">...and ${filtered.length - 200} more packages</div>`;
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Scan file for affected packages
        function scanFile() {
            if (!fileContent || !loadingComplete) return;
            
            const matches = [];
            const contentLower = fileContent.toLowerCase();
            
            for (const pkg of affectedPackages) {
                const pkgLower = pkg.toLowerCase();
                const index = contentLower.indexOf(pkgLower);
                
                if (index !== -1) {
                    const start = Math.max(0, index - 30);
                    const end = Math.min(fileContent.length, index + pkg.length + 30);
                    const context = fileContent.substring(start, end);
                    
                    const sources = [];
                    if (aikidoPackages.has(pkg)) sources.push('Aikido');
                    if (wizPackages.has(pkg)) sources.push('Wiz');
                    
                    matches.push({ package: pkg, context, sources: sources.join(', ') });
                }
            }
            
            // Update UI
            document.getElementById('foundCount').textContent = matches.length;
            const foundCard = document.getElementById('foundCount').parentElement;
            foundCard.classList.remove('danger', 'success');
            foundCard.classList.add(matches.length > 0 ? 'danger' : 'success');
            
            const alertDiv = document.getElementById('resultsAlert');
            alertDiv.innerHTML = matches.length > 0
                ? `<div class="alert alert-danger">‚ö†Ô∏è <strong>${matches.length}</strong> potentially compromised package(s) found!</div>`
                : `<div class="alert alert-success">‚úì No compromised packages found in your lock file.</div>`;
            
            document.getElementById('resultsList').innerHTML = matches.length > 0
                ? matches.map(m => `
                    <div class="result-item">
                        <span class="badge badge-danger">FOUND</span>
                        <span class="package-name">${escapeHtml(m.package)}</span>
                        <span class="package-source">(${m.sources})</span>
                        <div class="match-context">...${escapeHtml(m.context)}...</div>
                    </div>
                `).join('')
                : '<div style="text-align:center;color:#a0a0a0;padding:20px;">No compromised packages found üéâ</div>';
            
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        // Handle file upload
        function handleFile(file) {
            if (!loadingComplete) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                fileContent = e.target.result;
                document.getElementById('uploadedFileName').textContent = file.name;
                document.getElementById('uploadedFile').style.display = 'block';
                scanFile();
            };
            reader.readAsText(file);
        }
        
        // Clear file
        function clearFile() {
            fileContent = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadedFile').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('foundCount').textContent = '0';
            document.getElementById('foundCount').parentElement.classList.remove('danger', 'success');
        }
        
        // Event listeners
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => loadingComplete && fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); loadingComplete && uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (loadingComplete && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        document.getElementById('searchAffected').addEventListener('input', (e) => renderAffectedList(e.target.value));
        
        // Initialize
        loadPackages();
    </script>
</body>
</html>
